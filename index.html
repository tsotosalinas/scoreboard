<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scoros - TBC Basketball Scoreboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Roboto+Condensed:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Space Mono', 'Roboto Mono', monospace;
            background: #d3d3d3;
            color: white;
            overflow: hidden;
            height: 100vh;
            position: relative;
            /* Pattern de fond avec les ballons */
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="30" fill="none" stroke="white" stroke-width="2" opacity="0.3"/><path d="M20 50h60M50 20v60M35 35l30 30M35 65l30-30" stroke="white" stroke-width="1" opacity="0.2"/></svg>');
            background-size: 120px 120px;
            background-repeat: repeat;
        }

        .app-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            height: 100vh;
            gap: 40px;
            padding: 40px;
            position: relative;
        }

        /* Encadrés noirs pour les scores */
        .score-zone {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: #000000;
            border-radius: 0;
            padding: 60px 20px;
            position: relative;
            border: medium solid #E5DCCD;
        }

        .score-display {
            font-family: 'Space Mono', monospace;
            font-weight: 700;
            font-size: 12rem;
            color: #00ff00;
            margin-bottom: 40px;
            text-shadow: 0 0 30px rgba(0, 255, 0, 0.6);
            line-height: 0.8;
            text-align: center;
        }

        /* Contrôles sous les scores - disposition en ligne */
        .score-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            max-width: 280px;
            align-items: center;
        }

        .score-controls .top-row {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .score-controls .bottom-row {
            display: flex;
            justify-content: center;
            width: 100%;
        }

        .score-btn {
            background: #000000;
            color: white;
            border: 2px solid white;
            border-radius: 0;
            padding: 12px 20px;
            font-family: 'Space Mono', monospace;
            font-weight: 700;
            font-size: 1.8rem;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            min-width: 80px;
            text-align: center;
        }

        .score-btn:hover {
            background: #333;
        }

        .score-btn.feedback {
            background: #ff6b35;
            border-color: #ff6b35;
            color: white;
        }

        .score-btn.minus {
            min-width: 120px;
            background: #000000;
            border-color: white;
        }

        .shortcut {
            position: absolute;
            bottom: 3px;
            right: 6px;
            font-size: 0.7rem;
            color: #888;
            font-weight: 400;
        }

        /* Zone centrale avec logo et timer */
        .center-zone {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px 20px;
            background: #000000;
            position: relative;
        }

        .tbc-logo {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Roboto Condensed', sans-serif;
            font-weight: 900;
            font-size: 1.5rem;
            color: #000;
            margin-bottom: 40px;
            border: 3px solid #fff;
        }

        .timer-display {
            font-family: 'Space Mono', monospace;
            font-weight: 700;
            font-size: 8rem;
            color: #ffff00;
            text-shadow: 0 0 30px rgba(255, 255, 0, 0.6);
            margin-bottom: 50px;
            line-height: 0.8;
            text-align: center;
        }

        /* Contrôles centraux - selon votre maquette */
        .center-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            max-width: 320px;
            align-items: center;
        }

        .time-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 10px;
        }

        .center-btn, .score-btn {
            background: #000000;
            color: white;
            border: 2px solid white;
            border-radius: 0;
            padding: 15px 25px;
            font-family: 'Space Mono', monospace;
            font-weight: 700;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            text-align: center;
            min-width: 100px;
            /* Empêcher le focus outline */
            outline: none !important;
            -webkit-tap-highlight-color: transparent;
        }

        .center-btn:focus, .score-btn:focus {
            /* Supprimer complètement l'outline de focus */
            outline: none !important;
            box-shadow: none !important;
            border-color: white; /* Garder la bordure normale */
        }

        .center-btn:hover {
            background: #333;
        }

        .center-btn.feedback {
            background: #ff6b35;
            border-color: #ff6b35;
            color: white;
        }

        .center-btn.primary {
            background: #000000;
            color: white;
            border: 2px solid white;
        }

        .center-btn.wide {
            width: 100%;
            min-width: 200px;
        }

        /* Overlay pour GIFs - Version plein écran avec préservation des proportions */
        .gif-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            cursor: pointer;
        }

        .gif-overlay img {
            /* Utilise toute la largeur ou hauteur disponible selon la proportion */
            max-width: 100vw;
            max-height: 100vh;
            width: auto;
            height: auto;
            object-fit: contain;
            display: block;
            
            /* Animation d'entrée */
            opacity: 0;
            transform: scale(0.8);
            animation: gifEnter 0.3s ease-out forwards;
        }

        @keyframes gifEnter {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Animation de sortie */
        .gif-overlay.closing img {
            animation: gifExit 0.2s ease-in forwards;
        }

        @keyframes gifExit {
            from {
                opacity: 1;
                transform: scale(1);
            }
            to {
                opacity: 0;
                transform: scale(0.8);
            }
        }

        /* Indicateur de fermeture */
        .gif-overlay::after {
            content: "Cliquez pour fermer";
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255, 255, 255, 0.7);
            font-family: 'Space Mono', monospace;
            font-size: 0.9rem;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 16px;
            border-radius: 4px;
            opacity: 0;
            animation: fadeInDelay 1s ease-out 1s forwards;
        }

        @keyframes fadeInDelay {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Historique */
        .history-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 300px;
            max-height: 200px;
            background: rgba(0, 0, 0, 0.9);
            border-radius: 5px;
            padding: 15px;
            font-size: 0.8rem;
            overflow-y: auto;
            border: 1px solid #333;
            display: none;
        }

        .history-item {
            padding: 5px 0;
            border-bottom: 1px solid #333;
            color: #ccc;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        /* Responsive */
        @media (max-width: 1400px) {
            .app-container {
                gap: 20px;
                padding: 20px;
            }
            
            .score-display {
                font-size: 8rem;
            }
            
            .timer-display {
                font-size: 5rem;
            }
            
            .tbc-logo {
                width: 80px;
                height: 80px;
                font-size: 1.2rem;
            }
        }

        @media (max-width: 1200px) {
            .app-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto;
                gap: 15px;
                padding: 15px;
            }
            
            .score-zone {
                padding: 30px 15px;
            }
            
            .score-display {
                font-size: 4rem;
            }
            
            .timer-display {
                font-size: 3rem;
            }
            
            .score-btn {
                font-size: 1.4rem;
                padding: 10px 15px;
            }
        }

        /* État victoire */
        .victory {
            animation: victoryPulse 1s ease-in-out infinite alternate;
        }

        @keyframes victoryPulse {
            from { 
                color: #00ff00;
                text-shadow: 0 0 30px rgba(0, 255, 0, 0.6);
            }
            to { 
                color: #ffff00;
                text-shadow: 0 0 40px rgba(255, 255, 0, 0.8);
            }
        }

        /* Debug panel */
        .debug-panel {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            border-radius: 5px;
            font-size: 0.7rem;
            color: #888;
            display: none;
            border: 1px solid #333;
        }

        /* Amélioration des contrastes */
        .score-zone, .center-zone {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>
    <!-- Overlay pour les GIFs -->
    <div class="gif-overlay" id="gifOverlay">
        <img id="gifImage" src="" alt="Animation">
    </div>

    <!-- Container principal -->
    <div class="app-container">
        <!-- Zone score HOME (gauche) -->
        <div class="score-zone">
            <div class="team-name" id="homeName">HOME</div>
            <div class="score-display" id="homeScore">14</div>
            <div class="score-controls">
                <div class="top-row">
                    <button class="score-btn" id="home-1pt" onclick="executeAction('score1pt_home')">
                        +1<span class="shortcut" id="shortcut-home-1pt"></span>
                    </button>
                    <button class="score-btn" id="home-2pt" onclick="executeAction('score2pt_home')">
                        +2<span class="shortcut" id="shortcut-home-2pt"></span>
                    </button>
                    <button class="score-btn" id="home-3pt" onclick="executeAction('score3pt_home')">
                        +3<span class="shortcut" id="shortcut-home-3pt"></span>
                    </button>
                </div>
                <div class="bottom-row">
                    <button class="score-btn minus" id="home-minus" onclick="executeAction('minus_home')">
                        -1<span class="shortcut" id="shortcut-home-minus"></span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Zone centrale -->
        <div class="center-zone">
            <div class="tbc-logo" id="logoDisplay">TBC</div>
            <div class="timer-display" id="timerDisplay">9:39</div>
            
            <div class="center-controls">
                <div class="time-controls">
                    <button class="center-btn" id="add-time" onclick="executeAction('addTime', {seconds: 60})">
                        +1min<span class="shortcut" id="shortcut-add-time"></span>
                    </button>
                    <button class="center-btn primary" id="toggle-timer" onclick="executeAction('toggleTimer')">
                        PAUSE<span class="shortcut" id="shortcut-toggle-timer"></span>
                    </button>
                    <button class="center-btn" id="sub-time" onclick="executeAction('addTime', {seconds: -60})">
                        -1min<span class="shortcut" id="shortcut-sub-time"></span>
                    </button>
                </div>
                
                <button class="center-btn wide" id="reset" onclick="executeAction('resetGame')">
                    RESET<span class="shortcut" id="shortcut-reset"></span>
                </button>
                
                <button class="center-btn wide" id="buzzer" onclick="executeAction('buzzer')">
                    BUZZER<span class="shortcut" id="shortcut-buzzer"></span>
                </button>
                
                <button class="center-btn wide" id="omg" onclick="executeAction('omg')">
                    OMG<span class="shortcut" id="shortcut-omg"></span>
                </button>
            </div>
        </div>

        <!-- Zone score VISITOR (droite) -->
        <div class="score-zone">
            <div class="team-name" id="visitorName">VISITOR</div>
            <div class="score-display" id="visitorScore">30</div>
            <div class="score-controls">
                <div class="top-row">
                    <button class="score-btn" id="visitor-1pt" onclick="executeAction('score1pt_visitor')">
                        +1<span class="shortcut" id="shortcut-visitor-1pt"></span>
                    </button>
                    <button class="score-btn" id="visitor-2pt" onclick="executeAction('score2pt_visitor')">
                        +2<span class="shortcut" id="shortcut-visitor-2pt"></span>
                    </button>
                    <button class="score-btn" id="visitor-3pt" onclick="executeAction('score3pt_visitor')">
                        +3<span class="shortcut" id="shortcut-visitor-3pt"></span>
                    </button>
                </div>
                <div class="bottom-row">
                    <button class="score-btn minus" id="visitor-minus" onclick="executeAction('minus_visitor')">
                        -1<span class="shortcut" id="shortcut-visitor-minus"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Panel historique (caché par défaut) -->
    <div class="history-panel" id="historyPanel">
        <div id="historyContent"></div>
    </div>

    <!-- Debug panel -->
    <div class="debug-panel" id="debugPanel">
        Config loaded: <span id="configStatus">❌</span><br>
        Actions: <span id="actionsCount">0</span><br>
        Last action: <span id="lastAction">None</span><br>
        Shortcuts: <span id="shortcutsStatus">❌</span>
    </div>

    <script>
        console.log('🚀 DEBUT DEBUG - Initialisation Scoros');

        // Configuration par défaut avec nouvelles touches
        let config = {
            app: {
                name: "Scoros",
                fullName: "Scoros - TBC ScoreBoard",
                club: "Toulouse Basket Club",
                team: "Équipe Loisirs",
                motto: "Vamos Toros !",
                version: "2.0.0",
                matchDuration: 300
            },
            teams: {
                homeTeam: "HOME",
                visitorTeam: "VISITOR"
            },
            display: {
                layout: "symmetric",
                scoreSize: "12rem",
                timerSize: "8rem",
                scoreFontFamily: "'Space Mono', 'Roboto Mono', monospace",
                timerFontFamily: "'Space Mono', 'Roboto Mono', monospace",
                primaryColor: "#00ff00",
                secondaryColor: "#ffff00",
                backgroundColor: "#000000",
                feedbackColor: "#ff6b35",
                feedbackDuration: 2000,
                shortcutDisplay: {
                    enabled: true,
                    format: "({key})",
                    fontSize: "0.7rem",
                    color: "#888888"
                },
                showControls: true
            },
            assets: {
                logo: "./assets/tbc-logo.png",
                logoSize: "120px",
                backgroundImage: "./assets/basketball-pattern.jpg",
                backgroundOpacity: 0.15,
                backgroundSize: "cover",
                backgroundPosition: "center"
            },
            audio: {
                globalVolume: 0.8,
                sounds: {
                    buzzer: {
                        enabled: true,
                        files: ["data:audio/mpeg;base64,"],
                        volume: 1.0,
                        description: "Son du buzzer de fin de temps"
                    }
                }
            },
            animations: {
                enabled: true,
                overlayBackground: "#000000",
                overlayOpacity: 0.9
            },
            actions: {
                score1pt_home: { sounds: [], gifs: [], gifDuration: 1500, randomSelection: true, volume: 0.7 },
                score2pt_home: { sounds: [], gifs: [], gifDuration: 2000, randomSelection: true, volume: 0.8 },
                score3pt_home: { sounds: [], gifs: [], gifDuration: 2500, randomSelection: true, volume: 0.9 },
                score1pt_visitor: { sounds: [], gifs: [], gifDuration: 1500, randomSelection: true, volume: 0.7 },
                score2pt_visitor: { sounds: [], gifs: [], gifDuration: 2000, randomSelection: true, volume: 0.8 },
                score3pt_visitor: { sounds: [], gifs: [], gifDuration: 2500, randomSelection: true, volume: 0.9 },
                omg: { sounds: [], gifs: [], gifDuration: 3000, randomSelection: true, volume: 0.9 }
            },
            keyboard: {
                shortcuts: [
                    { key: "p", action: "toggleTimer", description: "Démarrer/Arrêter le chrono" },
                    { key: "q", action: "score1pt_home", description: "HOME : +1 point" },
                    { key: "w", action: "score2pt_home", description: "HOME : +2 points" },
                    { key: "e", action: "score3pt_home", description: "HOME : +3 points" },
                    { key: "a", action: "minus_home", description: "HOME : -1 point" },
                    { key: "u", action: "score1pt_visitor", description: "VISITOR : +1 point" },
                    { key: "i", action: "score2pt_visitor", description: "VISITOR : +2 points" },
                    { key: "o", action: "score3pt_visitor", description: "VISITOR : +3 points" },
                    { key: "j", action: "minus_visitor", description: "VISITOR : -1 point" },
                    { key: "m", action: "omg", description: "OMG - Geste de classe" },
                    { key: "b", action: "buzzer", description: "Buzzer manuel" },
                    { key: "z", action: "undoLastAction", description: "Annuler dernière action" },
                    { key: "r", action: "resetGame", description: "Nouveau match" },
                    { key: "t", action: "addTime", params: { seconds: 60 }, description: "+1 minute" },
                    { key: "y", action: "addTime", params: { seconds: -60 }, description: "-1 minute" }
                ]
            }
        };

        // État du jeu
        let gameState = {
            homeScore: 0,
            visitorScore: 0,
            timeMinutes: 5,
            timeSeconds: 0,
            isRunning: false,
            history: [],
            lastAction: null
        };

        let timerInterval;
        let feedbackTimeouts = new Map();

        // Chargement de la configuration
        async function loadConfig() {
            console.log('📄 Tentative de chargement de config.json...');
            try {
                // Vérifier si on est sur file:// (pas de serveur)
                if (window.location.protocol === 'file:') {
                    console.warn('Mode fichier local détecté. Pour utiliser config.json, veuillez utiliser un serveur web local.');
                    console.warn('Exemple: python -m http.server 8000 puis http://localhost:8000');
                    document.getElementById('configStatus').textContent = '⚠️';
                } else {
                    const response = await fetch('./config.json');
                    if (response.ok) {
                        const configText = await response.text();
                        console.log('📄 Config JSON chargé, taille:', configText.length, 'caractères');
                        
                        const loadedConfig = JSON.parse(configText);
                        
                        // Merge profond de la configuration
                        config = mergeConfig(config, loadedConfig);
                        document.getElementById('configStatus').textContent = '✅';
                        console.log('✅ Configuration chargée et fusionnée');
                    } else {
                        console.warn(`Fichier config.json non trouvé (status: ${response.status})`);
                        document.getElementById('configStatus').textContent = '⚠️';
                    }
                }
            } catch (error) {
                console.error('❌ Erreur lors du chargement de config.json:', error);
                document.getElementById('configStatus').textContent = '❌';
            }
        }

        // Fonction utilitaire pour merger les configs
        function mergeConfig(defaultConfig, loadedConfig) {
            const result = { ...defaultConfig };
            
            Object.keys(loadedConfig).forEach(key => {
                if (typeof loadedConfig[key] === 'object' && !Array.isArray(loadedConfig[key]) && loadedConfig[key] !== null) {
                    result[key] = { ...result[key], ...loadedConfig[key] };
                } else {
                    result[key] = loadedConfig[key];
                }
            });
            
            return result;
        }

        // Configuration des raccourcis clavier (VERSION CORRIGÉE)
        function setupKeyboardShortcuts() {
            console.log('⌨️ DEBUT DEBUG - Configuration raccourcis clavier');
            
            if (!config.keyboard || !config.keyboard.shortcuts) {
                console.error('❌ Aucun raccourci configuré dans config.keyboard.shortcuts');
                document.getElementById('shortcutsStatus').textContent = '❌ No config';
                return;
            }
            
            console.log('📋 Raccourcis à configurer:', config.keyboard.shortcuts.length);
            
            // GESTIONNAIRE UNIQUE pour tous les raccourcis
            document.addEventListener('keydown', function(e) {
                console.log('🎯 KEYDOWN détecté:', e.key, 'Code:', e.code);
                
                // Ignorer si on est dans un champ de saisie
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    console.log('🚫 Ignorer - dans un champ de saisie');
                    return;
                }
                
                // Chercher le raccourci dans la config
                const shortcut = config.keyboard.shortcuts.find(s => s.key === e.key);
                
                if (shortcut) {
                    console.log('✅ Raccourci trouvé:', shortcut.action, shortcut.description);
                    e.preventDefault(); // Empêcher le comportement par défaut
                    executeAction(shortcut.action, shortcut.params || {});
                } else {
                    console.log('🔍 Raccourci non assigné pour:', e.key);
                }
            });
            
            console.log('✅ Gestionnaire d\'événements keydown installé');
            document.getElementById('shortcutsStatus').textContent = '✅ Active';
        }

        // Affichage des raccourcis dans les placeholders (VERSION CORRIGÉE)
        function setupShortcutPlaceholders() {
            console.log('🏷️ DEBUT DEBUG - Configuration placeholders raccourcis');
            
            if (!config.display.shortcutDisplay.enabled) {
                console.log('⚠️ Affichage des raccourcis désactivé');
                return;
            }
            
            // Mapping des actions vers les éléments DOM
            const actionToElement = {
                'score1pt_home': 'shortcut-home-1pt',
                'score2pt_home': 'shortcut-home-2pt',
                'score3pt_home': 'shortcut-home-3pt',
                'minus_home': 'shortcut-home-minus',
                'score1pt_visitor': 'shortcut-visitor-1pt',
                'score2pt_visitor': 'shortcut-visitor-2pt',
                'score3pt_visitor': 'shortcut-visitor-3pt',
                'minus_visitor': 'shortcut-visitor-minus',
                'toggleTimer': 'shortcut-toggle-timer',
                'resetGame': 'shortcut-reset',
                'buzzer': 'shortcut-buzzer',
                'omg': 'shortcut-omg'
            };
            
            console.log('📝 Parcours des raccourcis configurés...');
            
            // Parcourir tous les raccourcis configurés
            config.keyboard.shortcuts.forEach((shortcut, index) => {
                console.log(`🔄 Raccourci ${index}: ${shortcut.key} → ${shortcut.action}`);
                
                let elementId = actionToElement[shortcut.action];
                
                // Cas spécial pour addTime
                if (shortcut.action === 'addTime' && shortcut.params) {
                    if (shortcut.params.seconds > 0) {
                        elementId = 'shortcut-add-time';
                    } else if (shortcut.params.seconds < 0) {
                        elementId = 'shortcut-sub-time';
                    }
                }
                
                if (elementId) {
                    const element = document.getElementById(elementId);
                    if (element) {
                        const keyDisplay = config.display.shortcutDisplay.format.replace('{key}', shortcut.key);
                        element.textContent = keyDisplay;
                        element.style.fontSize = config.display.shortcutDisplay.fontSize;
                        element.style.color = config.display.shortcutDisplay.color;
                        console.log(`✅ Placeholder mis à jour: ${elementId} → ${keyDisplay}`);
                    } else {
                        console.warn(`❌ Élément DOM non trouvé: ${elementId} pour ${shortcut.action}`);
                    }
                } else {
                    console.warn(`❌ Mapping non trouvé pour l'action: ${shortcut.action}`);
                }
            });
            
            console.log('✅ Configuration des placeholders terminée');
        }

        // Application de la configuration
        function applyConfiguration() {
            console.log('🔧 Application de la configuration...');
            
            // Noms des équipes
            const homeNameEl = document.getElementById('homeName');
            const visitorNameEl = document.getElementById('visitorName');
            if (homeNameEl && config.teams.homeTeam) {
                homeNameEl.textContent = config.teams.homeTeam;
            }
            if (visitorNameEl && config.teams.visitorTeam) {
                visitorNameEl.textContent = config.teams.visitorTeam;
            }
            
            // Logo
            if (config.assets.logo) {
                const logoDisplay = document.getElementById('logoDisplay');
                if (logoDisplay && (config.assets.logo.startsWith('http') || config.assets.logo.startsWith('./'))) {
                    logoDisplay.innerHTML = `<img src="${config.assets.logo}" alt="Logo" style="width: ${config.assets.logoSize}; height: ${config.assets.logoSize}; object-fit: contain;">`;
                }
            }
            
            // Couleurs
            const scoreElements = document.querySelectorAll('.score-display');
            scoreElements.forEach(el => {
                if (config.display.scoreFontFamily) el.style.fontFamily = config.display.scoreFontFamily;
                if (config.display.scoreSize) el.style.fontSize = config.display.scoreSize;
                if (config.display.primaryColor) el.style.color = config.display.primaryColor;
            });
            
            const timerElement = document.getElementById('timerDisplay');
            if (timerElement) {
                if (config.display.timerFontFamily) timerElement.style.fontFamily = config.display.timerFontFamily;
                if (config.display.timerSize) timerElement.style.fontSize = config.display.timerSize;
                if (config.display.secondaryColor) timerElement.style.color = config.display.secondaryColor;
            }
            
            // Image de fond
            if (config.assets.backgroundImage) {
                document.body.style.backgroundImage = `url(${config.assets.backgroundImage})`;
                if (config.assets.backgroundSize) document.body.style.backgroundSize = config.assets.backgroundSize;
                if (config.assets.backgroundPosition) document.body.style.backgroundPosition = config.assets.backgroundPosition;
                document.body.style.backgroundAttachment = 'fixed';
            }
            
            // Durée du match
            if (config.app.matchDuration) {
                gameState.timeMinutes = Math.floor(config.app.matchDuration / 60);
                gameState.timeSeconds = config.app.matchDuration % 60;
            }
            
            console.log('✅ Configuration appliquée');
        }

        // Exécution des actions
        function executeAction(actionName, params = {}) {
            console.log('🎬 Executing action:', actionName, params);
            
            switch (actionName) {
                case 'score1pt_home':
                    addScore('home', 1);
                    playActionEffects(actionName);
                    break;
                    
                case 'score2pt_home':
                    addScore('home', 2);
                    playActionEffects(actionName);
                    break;
                    
                case 'score3pt_home':
                    addScore('home', 3);
                    playActionEffects(actionName);
                    break;
                    
                case 'score1pt_visitor':
                    addScore('visitor', 1);
                    playActionEffects(actionName);
                    break;
                    
                case 'score2pt_visitor':
                    addScore('visitor', 2);
                    playActionEffects(actionName);
                    break;
                    
                case 'score3pt_visitor':
                    addScore('visitor', 3);
                    playActionEffects(actionName);
                    break;
                    
                case 'minus_home':
                    addScore('home', -1);
                    break;
                    
                case 'minus_visitor':
                    addScore('visitor', -1);
                    break;
                    
                case 'toggleTimer':
                    toggleTimer();
                    addToHistory(`Timer ${gameState.isRunning ? 'démarré' : 'arrêté'}`);
                    break;
                    
                case 'addTime':
                    const seconds = params.seconds || 60;
                    addTime(seconds);
                    break;
                    
                case 'resetGame':
                    resetGame();
                    break;
                    
                case 'buzzer':
                    playBuzzer();
                    break;
                    
                case 'omg':
                    playActionEffects('omg');
                    addToHistory('💥 Action OMG déclenchée !');
                    break;
                    
                case 'undoLastAction':
                    undoLastAction();
                    break;
                    
                default:
                    console.warn(`Action inconnue: ${actionName}`);
                    return;
            }
            
            showButtonFeedback(actionName, params);
            updateDisplay();
            document.getElementById('lastAction').textContent = actionName;
        }

        // Ajout de score
        function addScore(team, points) {
            const oldScore = gameState[team + 'Score'];
            gameState[team + 'Score'] = Math.max(0, gameState[team + 'Score'] + points);
            
            gameState.lastAction = {
                type: 'score',
                team: team,
                points: points,
                previousScore: oldScore
            };
            
            const teamName = config.teams[team + 'Team'] || team;
            const action = points > 0 ? 
                `${teamName} marque ${points} point(s)` : 
                `${teamName} perd ${Math.abs(points)} point(s)`;
            addToHistory(action);
            
            checkVictory();
        }

        // Gestion du timer
        function toggleTimer() {
            if (gameState.isRunning) {
                pauseTimer();
            } else {
                startTimer();
            }
        }

        function startTimer() {
            if (!gameState.isRunning) {
                gameState.isRunning = true;
                timerInterval = setInterval(() => {
                    if (gameState.timeSeconds > 0) {
                        gameState.timeSeconds--;
                    } else if (gameState.timeMinutes > 0) {
                        gameState.timeMinutes--;
                        gameState.timeSeconds = 59;
                    } else {
                        // Temps écoulé
                        pauseTimer();
                        playBuzzer();
                        addToHistory('Fin du temps réglementaire');
                    }
                    updateDisplay();
                }, 1000);
            }
        }

        function pauseTimer() {
            gameState.isRunning = false;
            clearInterval(timerInterval);
        }

        function addTime(seconds) {
            const totalSeconds = gameState.timeMinutes * 60 + gameState.timeSeconds + seconds;
            if (totalSeconds >= 0) {
                gameState.timeMinutes = Math.floor(totalSeconds / 60);
                gameState.timeSeconds = totalSeconds % 60;
                addToHistory(`Temps ajusté: ${seconds > 0 ? '+' : ''}${seconds}s`);
            }
        }

        // Effets audio et visuels
        function playActionEffects(actionName) {
            const action = config.actions[actionName];
            if (!action) return;
            
            // Son aléatoire
            if (action.sounds && action.sounds.length > 0) {
                const randomSound = action.sounds[Math.floor(Math.random() * action.sounds.length)];
                playSound(randomSound, action.volume);
            }
            
            // GIF aléatoire
            if (action.gifs && action.gifs.length > 0) {
                const randomGif = action.gifs[Math.floor(Math.random() * action.gifs.length)];
                showGifOverlay(randomGif, action.gifDuration);
            }
        }

        function playSound(soundFile, volume = 1.0) {
            if (!soundFile) return;
            
            try {
                const audio = new Audio(soundFile);
                audio.volume = volume * (config.audio.globalVolume || 0.8);
                audio.play().catch(e => console.warn('Impossible de jouer le son:', e));
            } catch (e) {
                console.warn('Erreur lors de la lecture du son:', e);
            }
        }

        // Fonction améliorée pour l'affichage GIF plein écran
        function showGifOverlay(gifFile, duration = 2000) {
            if (!gifFile) return;
            
            console.log('🎬 Affichage GIF plein écran:', gifFile);
            
            const overlay = document.getElementById('gifOverlay');
            const gifImage = document.getElementById('gifImage');
            
            // Gestionnaire de clic pour fermer
            function closeGifOverlay() {
                console.log('🎬 Fermeture GIF overlay');
                overlay.classList.add('closing');
                
                // Attendre la fin de l'animation de sortie
                setTimeout(() => {
                    overlay.style.display = 'none';
                    overlay.classList.remove('closing');
                    gifImage.src = '';
                    overlay.removeEventListener('click', closeGifOverlay);
                }, 200); // Durée de l'animation de sortie
            }
            
            // Charger et afficher le GIF
            gifImage.onload = () => {
                console.log('🎬 GIF chargé avec succès');
                overlay.style.display = 'flex';
                
                // Ajouter le gestionnaire de clic
                overlay.addEventListener('click', closeGifOverlay, { once: true });
                
                // Fermeture automatique après la durée spécifiée
                setTimeout(() => {
                    if (overlay.style.display === 'flex') {
                        closeGifOverlay();
                    }
                }, duration);
            };
            
            gifImage.onerror = () => {
                console.warn('❌ Erreur lors du chargement du GIF:', gifFile);
            };
            
            // Démarrer le chargement
            gifImage.src = gifFile;
        }

        function playBuzzer() {
            // Son de buzzer synthétique si pas de fichier configuré
            const buzzerSound = config.audio.sounds.buzzer;
            if (buzzerSound && buzzerSound.files && buzzerSound.files[0]) {
                playSound(buzzerSound.files[0], buzzerSound.volume);
            } else {
                // Buzzer synthétique de secours
                createSyntheticBuzzer();
            }
            addToHistory('Buzzer activé');
        }

        function createSyntheticBuzzer() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const duration = 1.2;
                
                function createBuzzerTone(frequency, startTime, duration, volume) {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.type = 'square';
                    oscillator.frequency.setValueAtTime(frequency, startTime);
                    
                    gainNode.gain.setValueAtTime(0, startTime);
                    gainNode.gain.linearRampToValueAtTime(volume, startTime + 0.02);
                    gainNode.gain.setValueAtTime(volume, startTime + 0.1);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, startTime + duration);
                    
                    oscillator.start(startTime);
                    oscillator.stop(startTime + duration);
                }
                
                const now = audioContext.currentTime;
                createBuzzerTone(220, now, duration, 0.3);
                createBuzzerTone(440, now, duration, 0.15);
                createBuzzerTone(110, now, duration, 0.2);
            } catch (e) {
                console.warn('Impossible de créer le buzzer synthétique:', e);
            }
        }

        // Feedback visuel des boutons
        function showButtonFeedback(actionName, params = {}) {
            // Mapping des actions vers les boutons
            const actionToButton = {
                'score1pt_home': 'home-1pt',
                'score2pt_home': 'home-2pt',
                'score3pt_home': 'home-3pt',
                'minus_home': 'home-minus',
                'score1pt_visitor': 'visitor-1pt',
                'score2pt_visitor': 'visitor-2pt',
                'score3pt_visitor': 'visitor-3pt',
                'minus_visitor': 'visitor-minus',
                'toggleTimer': 'toggle-timer',
                'resetGame': 'reset',
                'buzzer': 'buzzer',
                'omg': 'omg'
            };
            
            let buttonId = actionToButton[actionName];
            
            // Cas spécial pour addTime
            if (actionName === 'addTime' && params.seconds) {
                buttonId = params.seconds > 0 ? 'add-time' : 'sub-time';
            }
            
            const button = document.getElementById(buttonId);
            if (!button) {
                console.warn(`❌ Bouton non trouvé pour feedback: ${buttonId} (action: ${actionName})`);
                return;
            }
            
            console.log(`✨ Feedback visuel: ${buttonId}`);
            
            // Supprimer le feedback précédent s'il existe
            if (feedbackTimeouts.has(buttonId)) {
                clearTimeout(feedbackTimeouts.get(buttonId));
            }
            
            // Ajouter le feedback
            button.classList.add('feedback');
            
            // Programmer la suppression du feedback
            const timeout = setTimeout(() => {
                button.classList.remove('feedback');
                feedbackTimeouts.delete(buttonId);
            }, config.display.feedbackDuration);
            
            feedbackTimeouts.set(buttonId, timeout);
        }

        // Annuler la dernière action
        function undoLastAction() {
            if (!gameState.lastAction) {
                addToHistory('Aucune action à annuler');
                return;
            }
            
            const action = gameState.lastAction;
            
            if (action.type === 'score') {
                gameState[action.team + 'Score'] = action.previousScore;
                const teamName = config.teams[action.team + 'Team'] || action.team;
                addToHistory(`Annulation: ${teamName} ${action.points} point(s)`);
            }
            
            gameState.lastAction = null;
        }

        // Vérification de victoire
        function checkVictory() {
            const rules = config.rules?.victoryConditions;
            if (!rules || !rules.enabled) return;
            
            const homeScore = gameState.homeScore;
            const visitorScore = gameState.visitorScore;
            const maxScore = Math.max(homeScore, visitorScore);
            const minScore = Math.min(homeScore, visitorScore);
            
            if (maxScore >= rules.minScore && (maxScore - minScore) >= rules.scoreDifference) {
                const winner = homeScore > visitorScore ? 'home' : 'visitor';
                const winnerName = config.teams[winner + 'Team'];
                
                // Effet visuel de victoire
                document.getElementById(winner + 'Score').classList.add('victory');
                
                // Son et animation de victoire
                if (rules.playVictoryAnimation || rules.playVictorySound) {
                    executeAction(`victory_${winner}`);
                }
                
                addToHistory(`🏆 VICTOIRE: ${winnerName} !`);
            }
        }

        // Réinitialisation du jeu
        function resetGame() {
            if (confirm(`Voulez-vous vraiment commencer un nouveau match ?\n\nToutes les données actuelles seront perdues.`)) {
                pauseTimer();
                
                // Réinitialiser l'état
                gameState = {
                    homeScore: 0,
                    visitorScore: 0,
                    timeMinutes: Math.floor(config.app.matchDuration / 60),
                    timeSeconds: config.app.matchDuration % 60,
                    isRunning: false,
                    history: [],
                    lastAction: null
                };
                
                // Supprimer les effets de victoire
                document.getElementById('homeScore').classList.remove('victory');
                document.getElementById('visitorScore').classList.remove('victory');
                
                // Supprimer tous les feedbacks
                feedbackTimeouts.forEach((timeout, buttonId) => {
                    clearTimeout(timeout);
                    document.getElementById(buttonId)?.classList.remove('feedback');
                });
                feedbackTimeouts.clear();
                
                addToHistory('🔄 Nouveau match commencé');
                updateDisplay();
            }
        }

        // Historique
        function addToHistory(message) {
            const timeStr = `${gameState.timeMinutes.toString().padStart(2, '0')}:${gameState.timeSeconds.toString().padStart(2, '0')}`;
            gameState.history.unshift(`${timeStr} - ${message}`);
            
            // Limiter l'historique
            if (gameState.history.length > 50) {
                gameState.history = gameState.history.slice(0, 50);
            }
            
            updateHistoryDisplay();
        }

        function updateHistoryDisplay() {
            const historyContent = document.getElementById('historyContent');
            if (!historyContent) return;
            
            historyContent.innerHTML = gameState.history
                .slice(0, 10) // Afficher seulement les 10 derniers
                .map(item => `<div class="history-item">${item}</div>`)
                .join('');
        }

        // Mise à jour de l'affichage
        function updateDisplay() {
            // Scores
            document.getElementById('homeScore').textContent = gameState.homeScore;
            document.getElementById('visitorScore').textContent = gameState.visitorScore;
            
            // Timer
            const minutes = gameState.timeMinutes.toString().padStart(2, '0');
            const seconds = gameState.timeSeconds.toString().padStart(2, '0');
            document.getElementById('timerDisplay').textContent = `${minutes}:${seconds}`;
            
            // Bouton Play/Pause
            const toggleButton = document.getElementById('toggle-timer');
            if (toggleButton) {
                toggleButton.textContent = gameState.isRunning ? 'PAUSE' : 'PLAY';
            }
            
            // Compteur d'actions dans le debug
            const actionsCount = document.getElementById('actionsCount');
            if (actionsCount) {
                actionsCount.textContent = gameState.history.length;
            }
            
            // Sauvegarder l'état
            saveGameState();
        }

        // Sauvegarde et chargement de l'état
        function saveGameState() {
            try {
                localStorage.setItem('scoros_gamestate', JSON.stringify(gameState));
            } catch (e) {
                console.warn('Impossible de sauvegarder l\'état:', e);
            }
        }

        function loadGameState() {
            try {
                const saved = localStorage.getItem('scoros_gamestate');
                if (saved) {
                    const loadedState = JSON.parse(saved);
                    gameState = { ...gameState, ...loadedState };
                    console.log('État du jeu chargé');
                }
            } catch (e) {
                console.warn('Impossible de charger l\'état sauvegardé:', e);
            }
        }

        // Raccourcis pour le debug
        function toggleHistory() {
            const panel = document.getElementById('historyPanel');
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
        }

        function toggleDebug() {
            const panel = document.getElementById('debugPanel');
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
        }

        // Fonction de test manuel des raccourcis
        function testKeyboardShortcuts() {
            console.log('🧪 === TEST MANUEL DES RACCOURCIS ===');
            
            if (!config.keyboard || !config.keyboard.shortcuts) {
                console.error('❌ Pas de raccourcis configurés!');
                return;
            }
            
            console.log('📋 Raccourcis configurés:');
            config.keyboard.shortcuts.forEach((shortcut, i) => {
                console.log(`  ${i}: key="${shortcut.key}" action="${shortcut.action}"`);
            });
            
            console.log('');
            console.log('🎯 Test de recherche:');
            const testKeys = ['q', 'w', 'e', 'p', 'b'];
            testKeys.forEach(testKey => {
                const found = config.keyboard.shortcuts.find(s => s.key === testKey);
                console.log(`  "${testKey}" → ${found ? found.action : 'NON TROUVÉ'}`);
            });
            
            console.log('');
            console.log('🎮 Appuyez sur une touche pour tester...');
        }

        // GESTIONNAIRE D'ÉVÉNEMENTS UNIQUE pour les touches de debug (F1, F2, F3, F5)
        document.addEventListener('keydown', (e) => {
            // Ces raccourcis sont fixes et ne passent pas par la config
            switch(e.key) {
                case 'F1':
                    e.preventDefault();
                    console.log('🔧 F1 pressé → Toggle historique');
                    toggleHistory();
                    break;
                case 'F2':
                    e.preventDefault();
                    console.log('🔧 F2 pressé → Toggle debug');
                    toggleDebug();
                    break;
                case 'F3':
                    e.preventDefault();
                    console.log('🧪 F3 pressé → Test manuel raccourcis');
                    testKeyboardShortcuts();
                    break;
                case 'F5':
                    e.preventDefault();
                    console.log('🔧 F5 pressé → Reload');
                    location.reload();
                    break;
            }
        });

        // Initialisation
        window.addEventListener('load', async () => {
            console.log('🏀 Scoros - Basketball Scoreboard');
            console.log('🐂 Vamos Toros!');
            
            // Charger la configuration
            await loadConfig();
            
            // Appliquer la configuration (couleurs, polices, etc.)
            applyConfiguration();
            
            // IMPORTANT: Configurer les raccourcis clavier
            setupKeyboardShortcuts();
            
            // IMPORTANT: Afficher les raccourcis dans les placeholders
            setupShortcutPlaceholders();
            
            // Charger l'état sauvegardé
            loadGameState();
            
            // Valeurs par défaut pour la démo (comme sur votre maquette)
            if (gameState.homeScore === 0 && gameState.visitorScore === 0) {
                // Garder les valeurs de démo de la maquette au premier chargement
                gameState.homeScore = 14;
                gameState.visitorScore = 30;
                gameState.timeMinutes = 9;
                gameState.timeSeconds = 39;
            }
            
            // Mise à jour initiale
            updateDisplay();
            addToHistory('🚀 Scoros démarré');
            
            console.log('✅ Application initialisée');
            console.log('🎮 Raccourcis disponibles:');
            config.keyboard.shortcuts.forEach(s => {
                console.log(`  "${s.key}" → ${s.description}`);
            });
            console.log('🔧 Debug: F1=Historique, F2=Debug, F3=Test, F5=Reload');
            console.log('');
            console.log('🧪 Pour tester les raccourcis, appuyez sur les touches configurées');
            console.log('   Par exemple: q, w, e pour HOME ou u, i, o pour VISITOR');
        });

        // Sauvegarde avant fermeture
        window.addEventListener('beforeunload', () => {
            saveGameState();
        });

        // Gestion du plein écran (optionnel)
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        // Double-clic pour plein écran
        document.addEventListener('dblclick', (e) => {
            if (e.target.closest('.score-display') || e.target.closest('.timer-display')) {
                toggleFullscreen();
            }
        });
    </script>
</body>
</html>